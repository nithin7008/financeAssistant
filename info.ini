graph TB
    %% User Interface Layer
    User[ğŸ‘¤ User] --> WebUI[ğŸŒ Web Interface<br/>FastAPI Frontend]
    
    %% API Layer
    WebUI --> API[ğŸš€ FastAPI Backend<br/>main.py]
    
    %% Core Processing Flow
    API --> QP[ğŸ” Query Processor<br/>Natural Language Input]
    
    %% Semantic Search Branch
    QP --> ST[ğŸ§  SentenceTransformer<br/>all-MiniLM-L6-v2<br/>Text â†’ Vector Embeddings]
    ST --> ChromaDB[(ğŸ—‚ï¸ ChromaDB<br/>Vector Database)]
    
    %% ChromaDB Collections
    ChromaDB --> Schemas[ğŸ“‹ Table Schemas<br/>Database Structure]
    ChromaDB --> Rules[ğŸ“ SQL Rules<br/>Query Guidelines]
    ChromaDB --> Examples[ğŸ’¡ Query Examples<br/>NL â†’ SQL Pairs]
    ChromaDB --> Feedback[ğŸ“ User Feedback<br/>Corrections & Learning]
    
    %% AI Generation Branch
    QP --> PromptBuilder[ğŸ“ Prompt Builder<br/>Template Assembly]
    PromptBuilder --> Ollama[ğŸ¤– Ollama Server<br/>Mistral-7B-Instruct-v0.3]
    
    %% Data Sources for Prompt
    Schemas --> PromptBuilder
    Rules --> PromptBuilder
    Examples --> PromptBuilder
    Feedback --> PromptBuilder
    
    %% SQL Execution
    Ollama --> SQLGen[âš¡ Generated SQL]
    SQLGen --> SQLAlchemy[ğŸ”§ SQLAlchemy ORM]
    SQLAlchemy --> FinanceDB[(ğŸ’° Financial Database<br/>SQLite/PostgreSQL)]
    
    %% Database Tables
    FinanceDB --> Accounts[ğŸ¦ Accounts Table]
    FinanceDB --> Snapshots[ğŸ“Š Weekly Snapshots]
    FinanceDB --> Transactions[ğŸ’³ Transactions]
    
    %% Response Flow
    FinanceDB --> Results[ğŸ“ˆ Query Results]
    Results --> API
    API --> WebUI
    WebUI --> User
    
    %% Feedback Loop
    User --> FeedbackLoop[ğŸ”„ User Feedback<br/>Corrections]
    FeedbackLoop --> ChromaDB
    
    %% Data Import
    ExcelFiles[ğŸ“„ Excel Files] --> DataLoader[ğŸ“¥ Data Loader<br/>Pandas Processing]
    DataLoader --> FinanceDB
    
    %% External Services
    HuggingFace[ğŸ¤— Hugging Face<br/>Model Repository] -.-> ST
    OllamaModels[ğŸ“¦ Ollama Models<br/>Local Storage] -.-> Ollama
    
    %% Styling
    classDef userLayer fill:#e1f5fe
    classDef apiLayer fill:#f3e5f5
    classDef aiLayer fill:#fff3e0
    classDef dataLayer fill:#e8f5e8
    classDef storageLayer fill:#fce4ec
    
    class User,WebUI userLayer
    class API,QP,PromptBuilder apiLayer
    class ST,Ollama,SQLGen aiLayer
    class SQLAlchemy,DataLoader,Results dataLayer
    class ChromaDB,FinanceDB,Schemas,Rules,Examples,Feedback,Accounts,Snapshots,Transactions storageLayer
